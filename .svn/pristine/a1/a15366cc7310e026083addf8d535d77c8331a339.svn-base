<?php
/**
 * Created by PhpStorm.
 * User: Hector
 * Date: 3/9/2017
 * Time: 6:18 AM
 */
use Application\Info;
use Application\Model\AnswerableQuestion;
use Application\Model\Assessment;
use Application\Model\AssessmentQuestion;
use Application\Model\RunningAssessment;

/** @var Assessment $Assessment */
if(isset($this->Assessment)){
    $Assessment=$this->Assessment;
}
/** @var RunningAssessment $RunningAssessment */
$RunningAssessment=Info::AssessmentTable()->getRunningInstance($Assessment,Info::getCurrentUser()); ////TODO NEEDS ATENTION

?>

<div api-component="RunningAssessments" api-fetcher="get" api-parameter-id="<?php echo $RunningAssessment->getAnsweredID() ?>" class="running-assessment-main-container">
    <div class="assessment-info col-lg-12">
        <div class="assessment-name">
            <div class="action-attribute-label">Assessment Name: </div>
            <div class="action-attribute-value" api-attribute="Assessment->Name"></div>
        </div>
        <div class="assessment-description">
            <div class="action-attribute-label">Assessment Description: </div>
            <div class="action-attribute-value" api-attribute="Assessment->Description"></div>
        </div>
        <div class="assessment-type">
            <div class="action-attribute-label">Assessment Type: </div>
            <div class="action-attribute-value" api-attribute="Assessment->Type"></div>
        </div>
        <div class="assessment-timelimit">
            <div class="action-attribute-label">Assessment Timelimit: </div>
            <div class="action-attribute-value" api-attribute="Assessment->Timelimit"></div>
        </div>
    </div>
    <div class="assessment-info-second col-lg-12">
        <div api-render="question-status"></div>
    </div>
    <div api-render='questions' class="questions"></div>
</div>


<script>

    //var displayer=new QuestionDisplayWidget.instances[questionTypeID]();
    //callback?callback(displayer):true;//Modify the Displayer
    //displayer.open(element,questionID);

</script>

<?php













return;
?>
<style>
    .question-status:not([question-number]) {
        white-space:nowrap;
        width:15%;
        position: fixed;
    }
    .question-status[question-number]{
        padding:10px;
        font-size:20px;
        margin-top:10px;
        margin-bottom:10px;
        border-radius:10px;
        box-shadow:0px 1px 2px rgba(0,0,0,.4),inset 0px 2px rgba(255,255,255,.6);
        text-align:center;
    }
    .question-status[question-number][answered]{
        background:rgb(0, 230, 0);
        color:white;
        box-shadow:2px 4px 2px rgba(0,0,0,.4),inset 0px 1px rgba(255,255,255,.6);
    }

    .assessment-container {
        width:85%;
    }

</style>
<?php
/** @var string $QuestionViewing */


/** @var RunningAssessment $RunningAssessment */
/** @var AssessmentQuestion[] $AssessmentQuestions */
/** @var AnswerableQuestion[] $AnswerableQuestions */







/***************************************************************************/
$RunningAssessment=Info::AssessmentTable()->getRunningInstance($Assessment,Info::getCurrentUser()); ////TODO NEEDS ATENTION
$AssessmentQuestions=Info::AssessmentTable()->getAssessmentIssuedQuestions($Assessment); //TODO NEEDS ATENTION
$AnswerableQuestions=Info::AssessmentTable()->getAnswerableQuestions($RunningAssessment->getSessionID()); ////TODO NEEDS ATENTION
echo "<div class='col-lg-12'>\n";
echo "   <div class='col-lg-1 question-status'>";
$number=1;
foreach($AnswerableQuestions as $question){
    $answeredAttr=intval($question->getAttempts())>0?"answered":"";
    echo "        <div $answeredAttr question-number=$number class='question-status'><div class='question-status-item'>Question $number</div></div>\n";
    $number++;
}
echo "        <a style='display:none' href='/assessments/{$Assessment->getAssessmentID()}/submit' class='assessmentSubmitBtn btn btn-default btn-block'>Submit</a>\n";
echo "   </div>\n";
echo "   <div class='col-lg-1' style='width:15%'></div>\n";
echo "   <div class='assessment-container col-lg-11'>\n";
$number=1;
foreach($AnswerableQuestions as $question){
    $answeredAttr=intval($question->getAttempts())>0?"answered":"";
    echo "        <div  class='question'><h2><span class='label label-primary'>Question $number</span></h2>\n";
    echo "        <div $answeredAttr question-number=$number class='graded-question col-lg-12' AnswerableID='{$question->getAnswerableID()}'></div></div>\n";
    $number++;
}
echo "   </div>\n";
echo "</div>\n";
$this->inlineScript()->captureStart();
echo <<<JS
$(document).ready(function(){
    
    var answered=$(".assessment-container").find(".graded-question:not([answered])");
    if(answered.length==0){
        $(".assessmentSubmitBtn").css("display","");
    }
    $(".assessment-container").on("answered",".graded-question",function(){
        $(this).attr("answered",true);
        var QuestionNumber=$(this).attr("question-number");
        var questionContainer=$(this).parents(".question:first");
        var container=$(this).parents(".assessment-container:first");
        var answered=container.find(".graded-question:not([answered])");
        if(answered.length==0){
            $(".assessmentSubmitBtn").css("display","");
        }
        $(".question-status[question-number='"+QuestionNumber+"']").attr("answered",true);
        
    });
});


JS;

$this->inlineScript()->captureEnd();
?>

<?php
return;

$firstQuestionVisited=null;
$nextQuestionVisiting=null;
$questionVisiting=null;
$questionAnswerVisiting=null;
$previousQuestionVisiting=null;
foreach($AssessmentQuestions as $question){



    /***********************************************************************/
    /* When Found, do one more loop then catch it here to set the next     */
    /***********************************************************************/
    if($questionVisiting!=null)
    {
        $nextQuestionVisiting=$question;
        break;
    }

    /***********************************************************************/
    /* See if we find the one we want to view                              */
    /***********************************************************************/
    if($question->getAssessmentQuestionID()==$QuestionViewing){
        $questionVisiting=Info::QuestionsTable()->getFromById($question->getQuestionID());
        $questionAnswerVisiting=$question;
        continue;
    }

    /***********************************************************************/
    /* If not we definitely now its the previous
    /***********************************************************************/
    else{
        $previousQuestionVisiting=$question;
    }

    /***********************************************************************/
    if($firstQuestionVisited==null){
        $firstQuestionVisited=$question;
    }
    else if($nextQuestionVisiting==null){
        $nextQuestionVisiting=$question;
    }
}




/***************************************************************************/
/* Quick Test                                                              */
/***************************************************************************/
if($questionVisiting==null){
    $previousQuestionVisiting=null;
    $questionVisiting=Info::QuestionsTable()->getFromById($firstQuestionVisited->getQuestionID());
    $questionAnswerVisiting=$firstQuestionVisited;
}

/***************************************************************************/
/* Find Answer For This Question                                           */
/***************************************************************************/
$answeredInfoForThisQuestion=null;
foreach($AnswerableQuestions as $answer){
    if($answer->getAnswerableID()==$questionAnswerVisiting->getAssessmentQuestionID()){
        $answeredInfoForThisQuestion=$answer;
    }
}

/****************************************************************************/
/* We will do somthing different. We will display 'INTERACTIVE' question    */
/* if no answer, and static HTML if there is an answer...PERFECT!!!         */
/****************************************************************************/
if($answeredInfoForThisQuestion==null) {
    echo $this->partial("questions/answer/run", array("Question" => $questionVisiting,
        "AssessmentQuestion"=>$questionAnswerVisiting,
        "QuestionSessionID" => $questionAnswerVisiting->getAssessmentQuestionID(),
        "SessionID" => $RunningAssessment->getSessionID(),
        "Type" => "Assessment"));
}
else {
    echo "<div class='col-lg-12'>";
    echo '<h4><span class="label label-success">Answered</span></h4>';
    echo $answeredInfoForThisQuestion->getAnsweredHTML(); //PERFECT!!!!
    echo "</div>";
}

/****************************************************************************/
echo "<div class='col-lg-12' style='text-align:center'><h3><b>{$AssessmentQuestions->count()}/{$AnswerableQuestions->count()}</b>";
echo ($nextQuestionVisiting!=null)?"<span class='pull-right'><a href='/assessments/{$Assessment->getAssessmentID()}/run?QuestionNum={$nextQuestionVisiting->getAssessmentQuestionID()}' class='btn btn-lg btn-default'>Next</a></span>":"";
echo ($previousQuestionVisiting!=null)?"<span class='pull-left'><a href='/assessments/{$Assessment->getAssessmentID()}/run?QuestionNum={$previousQuestionVisiting->getAssessmentQuestionID()}' class='btn btn-lg btn-default'>Previous</a></span>":"";
echo "</h3></div>";

/***************************************************************************/
/*                  A S S E S S M E N T    F I N I S H                     */
/***************************************************************************/
if($AnswerableQuestions->count()==$AssessmentQuestions->count())
{
    echo "<a href='/assessments/{$Assessment->getAssessmentID()}/submit' class='btn btn-success' style='text-align:center'>Submit</a>";
}




?>




